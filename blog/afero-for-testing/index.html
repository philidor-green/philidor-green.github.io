<!doctype html>
<html data-n-head-ssr>
  <head>
    <title>Test file uploads with afero in Golang</title><meta data-n-head="ssr" charset="utf-8"><meta data-n-head="ssr" name="viewport" content="width=device-width,initial-scale=1"><meta data-n-head="ssr" name="theme-color" content="#4B6587"><meta data-n-head="ssr" property="og:title" content="Test file uploads with afero in Golang"><meta data-n-head="ssr" property="og:description" content="This is an example how to test http upload without access to real filesystem with afero."><meta data-n-head="ssr" property="og:image" content="https://philidor.dev/image.jpg"><link data-n-head="ssr" rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link data-n-head="ssr" rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link data-n-head="ssr" rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link data-n-head="ssr" rel="manifest" href="/site.webmanifest"><link data-n-head="ssr" rel="icon" type="image/x-icon" href="/favicon.ico"><link rel="preload" href="/_nuxt/40c199b.js" as="script"><link rel="preload" href="/_nuxt/339e023.js" as="script"><link rel="preload" href="/_nuxt/css/d194fe5.css" as="style"><link rel="preload" href="/_nuxt/b820847.js" as="script"><link rel="preload" href="/_nuxt/css/c2d66e2.css" as="style"><link rel="preload" href="/_nuxt/7a757dd.js" as="script"><link rel="preload" href="/_nuxt/css/449ff54.css" as="style"><link rel="preload" href="/_nuxt/99f074f.js" as="script"><link rel="stylesheet" href="/_nuxt/css/d194fe5.css"><link rel="stylesheet" href="/_nuxt/css/c2d66e2.css"><link rel="stylesheet" href="/_nuxt/css/449ff54.css"><link rel="preload" href="/_nuxt/static/1670571071/blog/afero-for-testing/state.js" as="script"><link rel="preload" href="/_nuxt/static/1670571071/blog/afero-for-testing/payload.js" as="script"><link rel="preload" href="/_nuxt/static/1670571071/manifest.js" as="script">
  </head>
  <body>
    <script data-n-head="ssr" data-hid="nuxt-color-mode-script" data-pbody="true">!function(){"use strict";var t=window,e=document,s=e.documentElement,a=["dark","light"],o=window.localStorage.getItem("nuxt-color-mode")||"system",c="system"===o?n():o,e=e.body.getAttribute("data-color-mode-forced");function r(e){e+="-mode";s.classList?s.classList.add(e):s.className+=" "+e}function l(e){return t.matchMedia("(prefers-color-scheme"+e+")")}function n(){if(t.matchMedia&&"not all"!==l("").media)for(var e of a)if(l(":"+e).matches)return e;return"light"}r(c=e?e:c),t.__NUXT_COLOR_MODE__={preference:o,value:c,getColorScheme:n,addClass:r,removeClass:function(e){e+="-mode";s.classList?s.classList.remove(e):s.className=s.className.replace(new RegExp(e,"g"),"")}}}()</script><div data-server-rendered="true" id="__nuxt"><!----><div id="__layout"><div class="pt-10 pt-15 sm:pt-20 lg:pt-20 md:pt-20 xl:pt-20"><div class="flex flex-col w-full"><div class="top-0 fixed w-full z-10 bg-header shadow-md"><div class="container mx-auto px-5"><div class="flex items-center py-2"><div class="w-1/2 text-white"><a href="/" class="nuxt-link-active">philidor.dev</a></div><div class="flex flex-row justify-end w-1/2"><div class="m-1 w-1/12"><a target="_blank" title="Hello!" href="#"><img src="/_nuxt/img/avatar.e680aeb.png" class="object-contain h-15 w-20"></a></div><div class="m-1 w-1/12"><a target="_blank" href="https://github.com/philidor-green"><img src="/_nuxt/img/github.c245266.svg" class="object-contain h-15 w-20"></a></div><div class="m-1 w-1/12"><a target="_blank" href="https://stackoverflow.com/users/2057388/%D0%97%D0%B5%D0%BB%D1%91%D0%BD%D1%8B%D0%B9?tab=profile"><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgZmlsbD0iI2U3ZTdkZSIgc2hhcGUtcmVuZGVyaW5nPSJnZW9tZXRyaWNQcmVjaXNpb24iIHRleHQtcmVuZGVyaW5nPSJnZW9tZXRyaWNQcmVjaXNpb24iIGltYWdlLXJlbmRlcmluZz0ib3B0aW1pemVRdWFsaXR5IiBmaWxsLXJ1bGU9ImV2ZW5vZGQiIGNsaXAtcnVsZT0iZXZlbm9kZCIgdmlld0JveD0iMCAwIDY0MCA2NDAiPjxwYXRoIGQ9Ik02NDAgNDAwLjAwOVY2NDBIMFY0MDAuMDA5aDc5Ljk5N3YxNTkuOTk0aDQ4MC4wMDZWNDAwLjAwOUg2NDB6bS01MTkuOTk5IDQwLjAwNGgzOTkuOTk3djc5Ljk5N0wxMjAuMDAxIDUyMHYtNzkuOTg2em05LjQ4NC04Ni42MjNsMTcuMzE2LTc4LjEwNyAzOTAuNTI0IDg2LjU2NC0xNy4zMjcgNzguMTItMzkwLjUxMy04Ni41Nzd6bTQ1LjMyLTE2MC41NDlsMzMuODAzLTcyLjUyIDM2Mi41MiAxNjkuMDMtMzMuODAzIDcyLjUzMi0zNjIuNTItMTY5LjA0em00NDUuMDMzIDMzLjA4M2wtNDguNzIxIDYzLjQ3NEwyNTMuNzUgNDUuODc1IDI4OC45NDggMGgzNi40MTRsMjk0LjQ3NiAyMjUuOTI0eiIvPjwvc3ZnPgo=" class="object-contain h-15 w-20"></a></div><div class="m-1 w-1/12"><a target="_blank" href="https://twitter.com/shindu666"><img src="/_nuxt/img/twitter.8e3028d.svg" class="object-contain h-15 w-20"></a></div><div class="m-1 w-1/12"><a target="_blank" href="https://t.me/philidor_green"><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGZpbGw9IiNlN2U3ZGUiIHZpZXdCb3g9IjAgMCAzMzMzMzQgMzMzMzM0IiBzaGFwZS1yZW5kZXJpbmc9Imdlb21ldHJpY1ByZWNpc2lvbiIgdGV4dC1yZW5kZXJpbmc9Imdlb21ldHJpY1ByZWNpc2lvbiIgaW1hZ2UtcmVuZGVyaW5nPSJvcHRpbWl6ZVF1YWxpdHkiIGZpbGwtcnVsZT0iZXZlbm9kZCIgY2xpcC1ydWxlPSJldmVub2RkIj48cGF0aCBkPSJNMTY2NjY3IDBjOTIwNDggMCAxNjY2NjcgNzQ2MTkgMTY2NjY3IDE2NjY2N3MtNzQ2MTkgMTY2NjY3LTE2NjY2NyAxNjY2NjdTMCAyNTg3MTUgMCAxNjY2NjcgNzQ2MTkgMCAxNjY2NjcgMHptODAyMTkgOTEyMDVsLTI5NzM1IDE0OTkxOXMtNDE1OCAxMDM5Ni0xNTU5NCA1NDA0bC02ODQxMC01Mzg1NHM3NjEwNC02ODQwOSA3OTIyMi03MTMyMGMzMTE5LTI5MTEgMjA3OS0zNTM0IDIwNzktMzUzNCAyMDctMzUzNS01NjE0IDAtNTYxNCAwbC0xMDA4NDYgNjQwNDMtNDIwMDItMTQxNDBzLTY0NDYtMjI4OC03MDY5LTcyNzdjLTYyNC00OTkyIDcyNzctNzY5NCA3Mjc3LTc2OTRsMTY2OTcwLTY1NDk4czEzNzIyLTYwMzAgMTM3MjIgMzk1MXptLTg3NjM3IDEyMjg4OWwtMjcxNDEgMjQ3NDVzLTIxMjIgMTYwOS00NDQzIDYwMWw1MTk3LTQ1OTY1IDI2Mzg3IDIwNjE5eiIvPjwvc3ZnPgo="></a></div><div class="m-1 w-1/12"><a target="_blank" href="https://www.linkedin.com/in/roman-kiselenko-583534201/"><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgZmlsbD0iI2U3ZTdkZSIgdmlld0JveD0iMCAwIDMzMzMgMzMzMyIgc2hhcGUtcmVuZGVyaW5nPSJnZW9tZXRyaWNQcmVjaXNpb24iIHRleHQtcmVuZGVyaW5nPSJnZW9tZXRyaWNQcmVjaXNpb24iIGltYWdlLXJlbmRlcmluZz0ib3B0aW1pemVRdWFsaXR5IiBmaWxsLXJ1bGU9ImV2ZW5vZGQiIGNsaXAtcnVsZT0iZXZlbm9kZCI+PHBhdGggZD0iTTE2NjcgMGM5MjAgMCAxNjY3IDc0NiAxNjY3IDE2NjcgMCA5MjAtNzQ2IDE2NjctMTY2NyAxNjY3Qzc0NyAzMzM0IDAgMjU4OCAwIDE2NjcgMCA3NDcgNzQ2IDAgMTY2NyAwem0tMjE1IDEzMzZoMzQydjE3NWg1YzQ4LTg2IDE2NC0xNzUgMzM4LTE3NSAzNjEgMCA0MjggMjI1IDQyOCA1MTd2NTk2aC0zNTd2LTUyOGMwLTEyNi0zLTI4OC0xODYtMjg4LTE4NiAwLTIxNCAxMzctMjE0IDI3OXY1MzdoLTM1N1YxMzM2em0tMjQ3LTMwOWMwIDEwMi04MyAxODYtMTg2IDE4Ni0xMDIgMC0xODYtODMtMTg2LTE4NiAwLTEwMiA4My0xODYgMTg2LTE4NiAxMDIgMCAxODYgODMgMTg2IDE4NnptLTM3MSAzMDloMzcxdjExMTNIODM0VjEzMzZ6Ii8+PC9zdmc+Cg==" class="object-contain h-15 w-20"></a></div></div></div></div></div><div class="container mx-auto px-5"><article class="container"><div class="nuxt-content"><h1 id="test-file-uploads-with-afero-in-golang"><a href="#test-file-uploads-with-afero-in-golang" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Test file uploads with afero in Golang</h1>
<p>Suppose we have a simple file upload http handler looks like this:</p>
<div class="nuxt-content-highlight"><pre class="line-numbers language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"fmt"</span>
    <span class="token string">"io"</span>
    <span class="token string">"log"</span>
    <span class="token string">"net/http"</span>
    <span class="token string">"os"</span>

    <span class="token string">"github.com/gorilla/mux"</span>
    <span class="token string">"github.com/rs/cors"</span>
<span class="token punctuation">)</span>

<span class="token keyword">const</span> MB <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">20</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    r <span class="token operator">:=</span> <span class="token operator">&</span>Router<span class="token punctuation">{</span><span class="token operator">&</span>mux<span class="token punctuation">.</span>Router<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span>

    r<span class="token punctuation">.</span><span class="token function">MustResponse</span><span class="token punctuation">(</span><span class="token string">"POST"</span><span class="token punctuation">,</span> <span class="token string">"/"</span><span class="token punctuation">,</span> <span class="token function">processFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    r<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token string">":8080"</span><span class="token punctuation">,</span> <span class="token string">"*"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">processFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> http<span class="token punctuation">.</span>HandlerFunc <span class="token punctuation">{</span>
    <span class="token keyword">return</span> http<span class="token punctuation">.</span><span class="token function">HandlerFunc</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>res http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> req <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> err <span class="token operator">:=</span> req<span class="token punctuation">.</span><span class="token function">ParseMultipartForm</span><span class="token punctuation">(</span><span class="token number">50</span> <span class="token operator">*</span> MB<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token boolean">nil</span> <span class="token operator">!=</span> err <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"while parse %s"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
            res<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusInternalServerError<span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            err <span class="token operator">:=</span> req<span class="token punctuation">.</span>MultipartForm<span class="token punctuation">.</span><span class="token function">RemoveAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"Cant delete multipart error %s"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> fheaders <span class="token operator">:=</span> <span class="token keyword">range</span> req<span class="token punctuation">.</span>MultipartForm<span class="token punctuation">.</span>File <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> hdr <span class="token operator">:=</span> <span class="token keyword">range</span> fheaders <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"Income file name: %s"</span><span class="token punctuation">,</span> hdr<span class="token punctuation">.</span>Filename<span class="token punctuation">)</span>

                infile<span class="token punctuation">,</span> err <span class="token operator">:=</span> hdr<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                    log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"Handle open error: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
                    res<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusInternalServerError<span class="token punctuation">)</span>
                    <span class="token keyword">continue</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">defer</span> infile<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

                f<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">OpenFile</span><span class="token punctuation">(</span><span class="token string">"./downloaded"</span><span class="token punctuation">,</span> os<span class="token punctuation">.</span>O_WRONLY<span class="token operator">|</span>os<span class="token punctuation">.</span>O_CREATE<span class="token punctuation">,</span> <span class="token number">0666</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                    log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"Create Read Input error %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
                    res<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusInternalServerError<span class="token punctuation">)</span>
                    <span class="token keyword">continue</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">defer</span> f<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                io<span class="token punctuation">.</span><span class="token function">Copy</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> infile<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        res<span class="token punctuation">.</span><span class="token function">Header</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"Content-Type"</span><span class="token punctuation">,</span> <span class="token string">"text/html"</span><span class="token punctuation">)</span>
        fmt<span class="token punctuation">.</span><span class="token function">Fprint</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> <span class="token string">"&lt;h2>Success&lt;/h2>"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Router <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    <span class="token operator">*</span>mux<span class="token punctuation">.</span>Router
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>Router<span class="token punctuation">)</span> <span class="token function">MustResponse</span><span class="token punctuation">(</span>meth<span class="token punctuation">,</span> path <span class="token builtin">string</span><span class="token punctuation">,</span> h http<span class="token punctuation">.</span>HandlerFunc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    r<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> h<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Methods</span><span class="token punctuation">(</span>meth<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>Router<span class="token punctuation">)</span> <span class="token function">Run</span><span class="token punctuation">(</span>address<span class="token punctuation">,</span> origins <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    c <span class="token operator">:=</span> cors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>cors<span class="token punctuation">.</span>Options<span class="token punctuation">{</span>
        AllowedOrigins<span class="token punctuation">:</span>   <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>origins<span class="token punctuation">}</span><span class="token punctuation">,</span>
        AllowedMethods<span class="token punctuation">:</span>   <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">"POST"</span><span class="token punctuation">,</span> <span class="token string">"GET"</span><span class="token punctuation">,</span> <span class="token string">"OPTIONS"</span><span class="token punctuation">,</span> <span class="token string">"PUT"</span><span class="token punctuation">,</span> <span class="token string">"DELETE"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        AllowedHeaders<span class="token punctuation">:</span>   <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">"Accept"</span><span class="token punctuation">,</span> <span class="token string">"Content-Type"</span><span class="token punctuation">,</span> <span class="token string">"If-None-Match"</span><span class="token punctuation">,</span> <span class="token string">"Content-Length"</span><span class="token punctuation">,</span> <span class="token string">"Accept-Encoding"</span><span class="token punctuation">,</span> <span class="token string">"Authorization"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        AllowCredentials<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    handler <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">Handler</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>
    http<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span>address<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">vars</span><span class="token punctuation">(</span>req <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> mux<span class="token punctuation">.</span><span class="token function">Vars</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>The code above is a common way to upload file onto server. The code below is for testing:</p>
<div class="nuxt-content-highlight"><pre class="line-numbers language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"bytes"</span>
    <span class="token string">"io"</span>
    <span class="token string">"mime/multipart"</span>
    <span class="token string">"net/http"</span>
    <span class="token string">"net/http/httptest"</span>
    <span class="token string">"os"</span>
    <span class="token string">"testing"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">TestMain</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    filePath <span class="token operator">:=</span> <span class="token string">"file.jpg"</span>
    fieldName <span class="token operator">:=</span> <span class="token string">"file"</span>
    body <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>bytes<span class="token punctuation">.</span>Buffer<span class="token punctuation">)</span>
    mw <span class="token operator">:=</span> multipart<span class="token punctuation">.</span><span class="token function">NewWriter</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span>
    file<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        t<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    w<span class="token punctuation">,</span> err <span class="token operator">:=</span> mw<span class="token punctuation">.</span><span class="token function">CreateFormFile</span><span class="token punctuation">(</span>fieldName<span class="token punctuation">,</span> filePath<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        t<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> io<span class="token punctuation">.</span><span class="token function">Copy</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        t<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    mw<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    req <span class="token operator">:=</span> httptest<span class="token punctuation">.</span><span class="token function">NewRequest</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>MethodPost<span class="token punctuation">,</span> <span class="token string">"/"</span><span class="token punctuation">,</span> body<span class="token punctuation">)</span>
    req<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">"Content-Type"</span><span class="token punctuation">,</span> mw<span class="token punctuation">.</span><span class="token function">FormDataContentType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    res <span class="token operator">:=</span> httptest<span class="token punctuation">.</span><span class="token function">NewRecorder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    handler <span class="token operator">:=</span> <span class="token function">processFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    handler<span class="token punctuation">.</span><span class="token function">ServeHTTP</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> req<span class="token punctuation">)</span>
    <span class="token keyword">if</span> res<span class="token punctuation">.</span>Code <span class="token operator">!=</span> <span class="token number">200</span> <span class="token punctuation">{</span>
        t<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"Expected %d, received %d"</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> res<span class="token punctuation">.</span>Code<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div>
<p>The problem here is that our test is actually working with real filesystem.
We need a bunch of things in order to have desired result.</p>
<ul>
<li>it needs actual file to upload</li>
<li>we should check uploaded file saved without errors</li>
<li>we should have a cleanup procedure in order to delete saved file</li>
</ul>
<p>There is a way to test our handler without access to real filesystem.
The <a href="https://github.com/spf13/afero" rel="nofollow noopener noreferrer" target="_blank">afero</a> can help here.</p>
<blockquote>
<p>The MemMapFs backend is perfect for testing.</p>
</blockquote>
<ul>
<li>Much faster than performing I/O operations on disk</li>
<li>Avoid security issues and permissions</li>
<li>Far more control. 'rm -rf /' with confidence</li>
<li>Test setup is far more easier to do</li>
<li>No test cleanup needed</li>
</ul>
<p>The output of our test:</p>
<div class="nuxt-content-highlight"><pre class="line-numbers language-text"><code>Running tool: /usr/bin/go test -timeout 30s -run ^TestMain$ httptestfs -v

=== RUN   TestMain
2022/01/13 15:24:21 Income file: file.jpg
--- PASS: TestMain (0.00s)
PASS
ok      httptestfs  0.002s
</code></pre></div>
<p>After tests the saved file is in the directory exactly how our handler process it.</p>
<p>Now let's use <code>afero</code>!</p>
<div class="nuxt-content-highlight"><pre class="line-numbers language-git"><code>diff --git main.go main.go
index 999fe42..2157943 100644
<span class="token deleted">--- main.go</span>
<span class="token inserted">+++ main.go</span>
@@ -9,6 +9,7 @@ import (

        <span class="token string">"github.com/gorilla/mux"</span>
        <span class="token string">"github.com/rs/cors"</span>
<span class="token inserted">+       "github.com/spf13/afero"</span>
 )

 const MB = 1 &lt;&lt; 20
@@ -16,12 +17,14 @@ const MB = 1 &lt;&lt; 20
 func main() {
        r := &Router{&mux.Router{}}

<span class="token deleted">-       r.MustResponse("POST", "/", processFile())</span>
<span class="token inserted">+       var AppFs = afero.NewOsFs()</span>
<span class="token inserted">+</span>
<span class="token inserted">+       r.MustResponse("POST", "/", processFile(AppFs))</span>

        r.Run(<span class="token string">":8080"</span>, <span class="token string">"*"</span>)
 }

<span class="token deleted">-func processFile() http.HandlerFunc {</span>
<span class="token inserted">+func processFile(fs afero.Fs) http.HandlerFunc {</span>
        return http.HandlerFunc(func(res http.ResponseWriter, req *http.Request) {
                if err := req.ParseMultipartForm(50 * MB); nil != err {
                        log.Printf(<span class="token string">"while parse %s"</span>, err)
@@ -38,7 +41,7 @@ func processFile() http.HandlerFunc {

                for _, fheaders := range req.MultipartForm.File {
                        for _, hdr := range fheaders {
<span class="token deleted">-                               log.Printf("Income file len: %d", hdr.Size)</span>
<span class="token inserted">+                               log.Printf("Income file: %s", hdr.Filename)</span>

                                infile, err := hdr.Open()
                                if err != nil {
@@ -48,7 +51,7 @@ func processFile() http.HandlerFunc {
                                }
                                defer infile.Close()

<span class="token deleted">-                               f, err := os.OpenFile("./downloaded", os.O_WRONLY|os.O_CREATE, 0666)</span>
<span class="token inserted">+                               f, err := fs.OpenFile("./downloaded", os.O_WRONLY|os.O_CREATE, 0666)</span>
                                if err != nil {
                                        log.Printf(<span class="token string">"Create Read Input error %v"</span>, err)
                                        res.WriteHeader(http.StatusInternalServerError)
diff --git main_test.go main_test.go
index d3875bf..66739c7 100644
<span class="token deleted">--- main_test.go</span>
<span class="token inserted">+++ main_test.go</span>
@@ -8,14 +8,19 @@ import (
        <span class="token string">"net/http/httptest"</span>
        <span class="token string">"os"</span>
        <span class="token string">"testing"</span>
<span class="token inserted">+</span>
<span class="token inserted">+       "github.com/spf13/afero"</span>
 )

 func TestMain(t *testing.T) {
        filePath := <span class="token string">"file.jpg"</span>
        fieldName := <span class="token string">"file"</span>
<span class="token inserted">+       var AppFs = afero.NewMemMapFs()</span>
<span class="token inserted">+</span>
        body := new(bytes.Buffer)
        mw := multipart.NewWriter(body)
<span class="token deleted">-       file, err := os.Open(filePath)</span>
<span class="token inserted">+       afero.WriteFile(AppFs, filePath, []byte("hello world"), 0644)</span>
<span class="token inserted">+       file, err := AppFs.Create(filePath)</span>
        if err != nil {
                t.Fatal(err)
        }
@@ -32,10 +37,15 @@ func TestMain(t *testing.T) {
        req := httptest.NewRequest(http.MethodPost, <span class="token string">"/"</span>, body)
        req.Header.Add(<span class="token string">"Content-Type"</span>, mw.FormDataContentType())
        res := httptest.NewRecorder()
<span class="token deleted">-       handler := processFile()</span>
<span class="token inserted">+       handler := processFile(AppFs)</span>

        handler.ServeHTTP(res, req)
        if res.Code != 200 {
                t.Errorf(<span class="token string">"Expected %d, received %d"</span>, 200, res.Code)
        }
<span class="token inserted">+       fileName := "downloaded"</span>
<span class="token inserted">+       _, err = AppFs.Stat(fileName)</span>
<span class="token inserted">+       if os.IsNotExist(err) {</span>
<span class="token inserted">+               t.Errorf("file \"%s\" does not exist.\n", fileName)</span>
<span class="token inserted">+       }</span>
</code></pre></div>
<p>With a little change we create a mock filesystem for testing purpose. Let's run new tests.</p>
<div class="nuxt-content-highlight"><pre class="line-numbers language-text"><code>Running tool: /usr/bin/go test -timeout 30s -run ^TestMain$ httptestfs -v

=== RUN   TestMain
2022/01/13 15:24:21 Income file: file.jpg
--- PASS: TestMain (0.00s)
PASS
ok      httptestfs  0.002s
</code></pre></div>
<p>It's pass! Let's break our handler to check if tests actually works.</p>
<div class="nuxt-content-highlight"><pre class="line-numbers language-git"><code><span class="token deleted">- f, err := os.OpenFile("./downloaded", os.O_WRONLY|os.O_CREATE, 0666)</span>
<span class="token inserted">+ f, err := fs.OpenFile("./download", os.O_WRONLY|os.O_CREATE, 0666)</span>
                                if err != nil {
</code></pre></div>
<p>Tests fails due to not exist file. Just as we want.</p>
<div class="nuxt-content-highlight"><pre class="line-numbers language-text"><code>Running tool: /usr/bin/go test -timeout 30s -run ^TestMain$ httptestfs -v

=== RUN   TestMain
2022/01/13 15:31:55 Income file: file.jpg
    /home/user/dev/httpfs/main_test.go:49: file "downloaded" does not exist.
--- FAIL: TestMain (0.00s)
FAIL
FAIL    httptestfs  0.002s
</code></pre></div>
<p>You can find the source code <a href="https://github.com/philidor-green/httpfs" rel="nofollow noopener noreferrer" target="_blank">here</a></p>
<p>Thanks.</p></div><!----><ul class="list-disc text-xs text-lightslategray-200"></ul></article><div class="flex flex-col items-center py-4 text-xs text-lightslategray-400"><div class="flex"><a target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">All the content on this site is licensed under  CC (BY-NC-SA)</a></div><div class="flex"><a target="_blank" href="https://content.nuxtjs.org/"><svg xmlns="http://www.w3.org/2000/svg" width="100" viewBox="0 0 1360 200" class="h-4 dark-img"><g fill="none" fill-rule="evenodd"><path d="M752.09356 137.76c-1.4858 1.49334-3.2966 2.24-5.43244 2.24-2.13584 0-3.94663-.74666-5.43243-2.24-1.4858-1.49334-2.22869-3.31332-2.22869-5.46V49.7c0-2.14668.74289-3.96666 2.22869-5.46 1.4858-1.49334 3.2966-2.24 5.43243-2.24 2.13584 0 3.96985.74666 5.50208 2.24 1.53223 1.49334 2.29834 3.31332 2.29834 5.46v33.6h36.07692V49.7c0-2.14668.7429-3.96666 2.2287-5.46 1.4858-1.49334 3.29659-2.24 5.43242-2.24 2.13584 0 3.96985.74666 5.50208 2.24C805.2339 45.73334 806 47.55332 806 49.7v82.6c0 2.14668-.7661 3.96666-2.29834 5.46-1.53223 1.49334-3.36624 2.24-5.50208 2.24-2.13583 0-3.94663-.74666-5.43243-2.24-1.4858-1.49334-2.22869-3.31332-2.22869-5.46V98.7h-36.07692v33.6c0 2.14668-.78932 3.96666-2.36798 5.46zM713.76536 44.24C715.25513 45.73334 716 47.55332 716 49.7s-.76815 3.99-2.30447 5.53-3.32867 2.31-5.3771 2.31h-22.2067v74.76c0 2.14668-.74487 3.96666-2.23463 5.46-1.48977 1.49334-3.3054 2.24-5.44693 2.24-2.14154 0-3.95716-.74666-5.44693-2.24-1.48977-1.49334-2.23464-3.31332-2.23464-5.46V57.54h-22.06704c-2.14153 0-3.95716-.77-5.44692-2.31C641.74487 53.69 641 51.84668 641 49.7c0-2.14668.74487-3.96666 2.23464-5.46 1.48976-1.49334 3.30539-2.24 5.44692-2.24h59.63688c2.14153 0 3.95716.74666 5.44692 2.24zM606 49.7c0-2.14668.76876-3.96666 2.3063-5.46 1.53755-1.49334 3.4114-2.24 5.62163-2.24 2.21022 0 4.1081.74666 5.6937 2.24C621.20721 45.73334 622 47.55332 622 49.7v82.6c0 2.14668-.79278 3.96666-2.37838 5.46s-3.48347 2.24-5.6937 2.24c-2.21021 0-4.08407-.74666-5.62161-2.24C606.76876 136.26666 606 134.44668 606 132.3V49.7zM492.36045 138.59978l-1.1209.84013h-.14011c-.28023 0-.70057.14002-1.26102.42007h-.42034c-.28023.09335-.72392.14002-1.33108.14002s-1.05084-.04667-1.33107-.14002h-.42034c-.56046-.1867-.88738-.30338-.9808-.35006-.0934-.04667-.25687-.11668-.49039-.21003-.23352-.09335-.5838-.32671-1.05085-.7001h-.1401c-.37365-.28005-.74728-.6301-1.12091-1.05017-.37364-.42007-.65386-.72344-.84068-.91014v-.14002c-.09341-.09335-.21017-.30338-.35028-.6301-.14012-.32672-.25688-.53675-.35029-.6301l-34.46782-81.63262c-.74727-1.96031-.72392-3.9206.07006-5.8809.79398-1.96032 2.17174-3.31385 4.13333-4.06063 1.86819-.84014 3.8064-.86348 5.8147-.07001 2.0083.79345 3.38606 2.17032 4.13333 4.13063l27.46217 64.83003 18.07459-42.98665c1.30773-3.17384 3.71298-4.76074 7.21582-4.76074 3.50285 0 5.9548 1.5869 7.35594 4.76074l18.07459 42.98665 27.32205-64.83003c.84068-1.9603 2.2418-3.33718 4.2034-4.13063 1.96159-.79347 3.92315-.79347 5.88474 0 1.9616.79345 3.33936 2.19366 4.13334 4.20064.79398 2.007.77063 3.94394-.07006 5.8109l-34.3277 81.63262c-.18682.74679-.70056 1.49356-1.54125 2.24035 0 .09335-.0467.23337-.14011.42006-.37364.1867-.70056.42007-.9808.70011h-.1401l-1.26102.84013h-.14012c-.0934 0-.18681.02334-.28022.07001-.09341.04668-.42034.16336-.9808.35006h-.28022c-.28023.09335-.72392.14002-1.33108.14002-.60715 0-1.05084-.04667-1.33107-.14002h-.42034c-.56045-.1867-.88738-.30338-.98079-.35006-.0934-.04667-.25687-.09334-.4904-.14002-.23352-.04667-.5838-.30337-1.05084-.77012h-.14012c-.84068-.56009-1.44783-1.21351-1.82147-1.9603-.37363-.1867-.65386-.65343-.84068-1.40022l-18.35481-43.4067-18.35482 43.4067c-.0934.28005-.28022.7001-.56045 1.2602l-.98079.98015c0 .09335-.0467.23337-.14011.42006-.18682.09335-.46704.32672-.84068.70011h-.28023z" fill="#00C48D" fill-rule="nonzero"></path> <path d="M383.76536 44.24C385.25513 45.73334 386 47.55332 386 49.7s-.76815 3.99-2.30447 5.53-3.32867 2.31-5.3771 2.31h-22.2067v74.76c0 2.14668-.74487 3.96666-2.23464 5.46-1.48976 1.49334-3.30539 2.24-5.44692 2.24-2.14154 0-3.95716-.74666-5.44693-2.24-1.48977-1.49334-2.23464-3.31332-2.23464-5.46V57.54h-22.06704c-2.14153 0-3.95716-.77-5.44692-2.31C311.74487 53.69 311 51.84668 311 49.7c0-2.14668.74487-3.96666 2.23464-5.46 1.48976-1.49334 3.30539-2.24 5.44692-2.24h59.63688c2.14153 0 3.95716.74666 5.44692 2.24zM247.67735 140c-2.14037 0-3.955-.74666-5.44394-2.24C240.74446 136.26666 240 134.44668 240 132.3V49.7c0-2.14668.74446-3.96666 2.23341-5.46s3.30357-2.24 5.44394-2.24c2.14036 0 3.97825.74666 5.51373 2.24 1.53547 1.49334 2.3032 3.31332 2.3032 5.46v74.76h37.82837c2.0473 0 3.83867.77 5.37415 2.31 1.53547 1.54 2.3032 3.35999 2.3032 5.46s-.76773 3.92-2.3032 5.46c-1.53548 1.54-3.32684 2.31-5.37415 2.31h-45.6453zM197 49.7c0-2.14668.76876-3.96666 2.3063-5.46 1.53755-1.49334 3.4114-2.24 5.62163-2.24 2.21022 0 4.1081.74666 5.6937 2.24C212.2072 45.73334 213 47.55332 213 49.7v82.6c0 2.14668-.79279 3.96666-2.37838 5.46-1.5856 1.49334-3.48347 2.24-5.6937 2.24-2.21021 0-4.08407-.74666-5.62161-2.24C197.76876 136.26666 197 134.44668 197 132.3V49.7zM164 98.54c0 11.10672-3.9472 20.62663-11.8417 28.56-7.8945 7.93337-17.44717 11.9-28.6583 11.9s-20.7638-3.9433-28.6583-11.83C86.9472 119.2833 83 109.74006 83 98.54V48.7c0-2.14668.7474-3.96666 2.24221-5.46 1.49482-1.49334 3.3166-2.24 5.4654-2.24 2.1488 0 3.99394.74666 5.53547 2.24 1.54153 1.49334 2.31228 3.31332 2.31228 5.46v49.84c0 6.81337 2.42905 12.66998 7.2872 17.57 4.85816 4.90002 10.74391 7.35 17.65744 7.35 6.91353 0 12.79928-2.42664 17.65744-7.28 4.85815-4.85336 7.2872-10.7333 7.2872-17.64V48.7c0-2.14668.77075-3.96666 2.31228-5.46 1.54153-1.49334 3.38667-2.24 5.53547-2.24s3.97058.74666 5.4654 2.24C163.2526 44.73334 164 46.55332 164 48.7v49.84zM8.26 140l-.14-.14c-.09333 0-.23333.04667-.42.14-2.14668 0-3.96666-.74666-5.46-2.24C.74666 136.26666 0 134.44668 0 132.3V49.7c0-2.14668.74666-3.96666 2.24-5.46C3.73334 42.74666 5.55332 42 7.7 42h19.88c7.37337 0 13.64997 2.58997 18.83 7.77 5.18003 5.18003 7.77 11.0833 7.77 17.71 0 6.6267-1.77332 12.31998-5.32 17.08 4.29335 2.70668 7.72332 6.29998 10.29 10.78 2.56668 4.48002 3.85 9.3333 3.85 14.56 0 8.3067-2.91664 15.39997-8.75 21.28-5.83336 5.88003-12.9033 8.82-21.21 8.82H8.26zm7.28-82.46v22.4h12.04c3.08002 0 5.69332-1.11999 7.84-3.36s3.22-4.89998 3.22-7.98-1.07332-5.69332-3.22-7.84-4.75998-3.22-7.84-3.22H15.54zm0 37.94v28.98h17.5c4.01335-.09333 7.41999-1.53999 10.22-4.34 2.80001-2.80001 4.2-6.20665 4.2-10.22 0-4.01335-1.39999-7.39665-4.2-10.15-2.80001-2.75335-6.20665-4.17667-10.22-4.27h-17.5z" fill="#FFF" fill-rule="nonzero"></path> <g fill-rule="nonzero" transform="translate(865)"><path d="M105.41346 38.55829l-6.33111 11.13597-21.65186-38.0943-66.46753 116.92767h45.00297c0 6.15023 4.90828 11.13597 10.96296 11.13597H10.96296c-3.91631 0-7.5348-2.12357-9.49262-5.5689-1.95783-3.44535-1.95763-7.6899.00052-11.13505L67.9384 6.03198c1.9583-3.44565 5.57756-5.5683 9.49438-5.5683 3.91681 0 7.53608 2.12265 9.49438 5.5683l18.4863 32.52631z" fill="#00C58E"></path> <path d="M153.3947 122.95965l-41.65013-73.2654-6.33111-11.13596-6.33111 11.13597-41.64556 73.26539c-1.95816 3.44515-1.95836 7.6897-.00053 11.13504 1.95783 3.44534 5.57632 5.56891 9.49263 5.56891h76.96c3.91713 0 7.5371-2.12126 9.49605-5.5669 1.95895-3.44564 1.95918-7.69118.00062-11.13705h.00913zm-86.46581 5.56798l38.48457-67.6974 38.47543 67.6974h-76.96z" fill="#FFF"></path> <path d="M183.17284 134.09562c-1.95797 3.44482-5.57616 5.56798-9.4921 5.56798H143.8889c6.05468 0 10.96296-4.98574 10.96296-11.13597h18.80605l-53.36222-93.88085-8.55111 15.04748-6.33111-11.13597 5.39012-9.4795c1.9583-3.44565 5.57757-5.5683 9.49438-5.5683 3.91682 0 7.53609 2.12265 9.49439 5.5683l53.38049 93.88086c1.95834 3.44548 1.95834 7.69049 0 11.13597z" fill="#108775"></path></g></g></svg></a></div></div></div></div></div></div></div><script defer src="/_nuxt/static/1670571071/blog/afero-for-testing/state.js"></script><script src="/_nuxt/40c199b.js" defer></script><script src="/_nuxt/99f074f.js" defer></script><script src="/_nuxt/339e023.js" defer></script><script src="/_nuxt/b820847.js" defer></script><script src="/_nuxt/7a757dd.js" defer></script>
  </body>
</html>
